# UAV TUI Dashboard 提交审查（2025-09-28）

本文档记录一次对 UAV TUI Dashboard 工具的代码审查结果与后续行动计划，面向“准备进入主线”的质量标准。

## 概要

- 可运行的 Textual TUI 仪表板，展示无人机姿态与电池状态（当前为模拟数据）。
- 仓库包含本地虚拟环境，依赖未锁定，架构耦合，测试/CI/发布脚手架缺失。
- 结论：可演示，不宜直接入主线。需完成仓库清理、分层重构、依赖与CI、最小测试与文档。

## 主要问题与优先级

### 高优先级（立即处理）
1. 仓库卫生：移除已提交的 venv（`UAV_TUI/`），新增 `.gitignore` 排除此类目录；README 改为本地创建虚拟环境。
2. 依赖与发布：`requirements.txt` 为空；引入 `pyproject.toml` 或填充 `requirements*.txt`，固定直接依赖版本；提供可执行入口（console script）。
3. 分层重构：
   - `src/core/models.py`：数据模型 `UAVStatus`（可用 pydantic 校验）。
   - `src/core/datasource.py`：抽象 `DataSource` + `SimDataSource` 实现。
   - `src/ui/app.py`：Textual App，仅消费状态，不关心来源。
   - `src/main.py`：参数解析（sim/ros2），装配数据源与 UI。
4. 运行时稳健性：用 `set_interval` 或消息机制替代裸 `create_task` 循环；统一 `logging`；优雅关闭与异常保护。

### 中优先级（本周内）
1. 测试与 CI：pytest（模型/数据源/基础 UI）、ruff + mypy、GitHub Actions 三步（lint/type/test）。
2. ROS2 接入骨架：`Ros2DataSource` 后台线程 + 队列/回调；话题可配置；无 ROS 时退化到模拟。
3. 文档：README 扩展“开发/测试/发布”，补充 `ROADMAP.md` 里程碑与验收标准。

### 低优先级（持续演进）
- UI 提升：基于 row key 的更新、格式化和告警配色、暂停/步进、统计面板。
- 可观测性：刷新频率、延迟、丢包计数、错误计数。

## 接口与数据契约（建议）

- 输入：
  - 位姿：nav_msgs/Odometry 或 geometry_msgs/PoseWithCovarianceStamped。
  - 电池：sensor_msgs/BatteryState。
  - 频率：1–10 Hz 可配置；缺失字段允许并显示“—”。
- `UAVStatus`：
  - `position: (x, y, z)`，`orientation: (roll, pitch, yaw)`（单位统一：度或弧度）。
  - `battery_level: 0–100`，`voltage: float`。
- 错误模式：
  - 超时：UI 顶部告警，日志 warning；
  - 反序列化错误：丢弃该帧并计数。
- 成功标准：无 ROS 与有 ROS 环境均可运行，UI 不崩并有告警降级。

## 建议的代码结构

```
src/
  core/
    models.py
    datasource.py  # DataSource 抽象, SimDataSource, (占位)Ros2DataSource
  ui/
    app.py
    dashboard.css
  main.py
tests/
  test_models.py
  test_datasource_sim.py
  test_ui_smoke.py
.github/workflows/ci.yml
pyproject.toml 或 requirements*.txt
.gitignore
```

## 具体改动建议（小步快跑）

- 将 `update_data` 改为 `set_interval(1.0, tick)`；在 `tick` 中读取最新状态并更新 UI。
- DataTable 使用行 key：`add_row(..., key="pos_x")`，更新时 `update_cell("pos_x", "Value", value)`。
- `update_table` try/except 保护，异常只记录日志不崩溃。
- README 增加“开发者指南”、“ROS2/非ROS运行方式”、“常见问题（ROS 环境变量）”。

## 路线图与验收

- 里程碑 M0（1 天）：
  - 清理 venv、`.gitignore`、依赖文件；分层重构；日志与优雅关闭。
  - 验收：模拟模式运行稳定；最小 pytest 通过；CI 绿色。
- 里程碑 M1（2–3 天）：
  - `Ros2DataSource` 骨架、配置化话题、断连告警。
  - 验收：ROS2 环境能显示真实数据，无 ROS 回退模拟。
- 里程碑 M2（2 天）：
  - 覆盖率提升 >60%；异常与超时路径覆盖。
- 里程碑 M3（1 天）：
  - 发布脚手架（console script）、文档完善、预发布 tag。

## 附：当前代码快照的关键点评估

- 优点：结构简单、可运行、易于演示；Textual 选型适合 TUI。
- 风险：模块内聚过强、无契约/无测试、更新循环粗糙、无依赖锁定、仓库污染（venv）。

---

如需，我可以按本文结构直接提交：
1) `.gitignore` 与依赖文件；2) 代码分层与入口重组；3) 最小测试与 CI；保留现有模拟功能，新增 ROS2 数据源占位实现。